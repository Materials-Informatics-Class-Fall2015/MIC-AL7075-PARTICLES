# This is an example PBS script for use on the FoRCE system with our granulous queue
#PBS -N testing_data
#PBS -l nodes=1:ppn=6
#PBS -l pmem=2gb
#PBS -l walltime=23:00:00
#PBS -q granulous
#PBS -j oe
#PBS -m abe
#PBS -M pkern3@gatech.edu
#PBS -V

module rm intel/12.0.0.084
module load intel/10.1.018

# Change python to right version for fatigue
module unload python
module load python/2.7

##### Items configured by the Python script #####
ABQ10="/usr/local/packages/abaqus/6.10-1/6.10-1/exec/abq6101.exe"
ABQ9="/usr/local/packages/abaqus/6.9/6.9-1/exec/abq691.exe"
ABQ7="/usr/local/packages/abaqus/6.7/6.7-1/exec/abq671.exe"
NCPU="6"
#NUM is replaced by actual folder in new code to modify PBS
NUM=3

# Define and Make the new scratch directory
BATCHNAME=testing_data

SCRATCH_DIR=~/scratch/${BATCHNAME}/Results_${PBS_JOBID}
FINAL_DIR=~/data/archived_results/${BATCHNAME}/${NUM}
mkdir -p ${SCRATCH_DIR}
cd ${PBS_O_WORKDIR}
INPT="main_2.inp"
cp ${INPT} ${SCRATCH_DIR}/${INPT}
INPT1="Grains_2.txt"
cp ${INPT1} ${SCRATCH_DIR}/${INPT1}
INPT2="Geom_Def_2.txt"
cp ${INPT2} ${SCRATCH_DIR}/${INPT2}
INPT3="Min_dist_2.txt"
cp ${INPT3} ${SCRATCH_DIR}/${INPT3}
INPT4="Neighbor_grains_2.txt"
cp ${INPT4} ${SCRATCH_DIR}/${INPT4}
INPT5="El_pos_2.txt"
cp ${INPT5} ${SCRATCH_DIR}/${INPT5}
INPT6="Neighbors_el_2.txt"
cp ${INPT6} ${SCRATCH_DIR}/${INPT6}
INPT7="Num_layer_2.txt"
cp ${INPT7} ${SCRATCH_DIR}/${INPT7}
INPT8="Sort_el_pos_2.txt"
cp ${INPT8} ${SCRATCH_DIR}/${INPT8}
INPT9="Grain_Centers_2.txt"
cp ${INPT9} ${SCRATCH_DIR}/${INPT9}
INPT10="Element_Volume_2.txt"
cp ${INPT10} ${SCRATCH_DIR}/${INPT10}
INPT11="Al_v144.f"
cp ${INPT11} ${SCRATCH_DIR}/${INPT11}
INPT12="removeNumbers.py"
cp ${INPT12} ${SCRATCH_DIR}/${INPT12}
INPT13="addNumbers.py"
cp ${INPT13} ${SCRATCH_DIR}/${INPT13}
INPT14="Common_block_Alv02.txt"
cp ${INPT14} ${SCRATCH_DIR}/${INPT14}
INPT15="Definitions.txt"
cp ${INPT15} ${SCRATCH_DIR}/${INPT15}
INPT16="post_process.py"
cp ${INPT16} ${SCRATCH_DIR}/${INPT16}
INPT17="Main.py"
cp ${INPT17} ${SCRATCH_DIR}/${INPT17}
INPT18="CrackClasses.py"
cp ${INPT18} ${SCRATCH_DIR}/${INPT18}
INPT19="abaqus_v6.env"
cp ${INPT19} ${SCRATCH_DIR}/${INPT19}
INPT20="ExtractODBdata.py"
cp ${INPT20} ${SCRATCH_DIR}/${INPT20}
INPT21="loads.inp"
cp ${INPT21} ${SCRATCH_DIR}/${INPT21}

#### Total Number of Jobs Submitted = 1 ####

########## Job Submission - 1 ##########

cd ${PBS_O_WORKDIR}

# Define ABAQUS UMAT file, input file, and job name
ROOT="ABAQUS"
JOBN=Results_${INPT}${PBS_JOBID}

#cp all INPT files is added to the PBS file via Python so that all input files are copied over


# Migrate to scratch directory and execute Abaqus
cd ${SCRATCH_DIR}

#first trim filenames so that they are all standard without number
python removeNumbers.py

${ABQ9} job=${JOBN} input=${INPT} scratch=${SCRATCH_DIR} user=Al_v144.f cpus=${NCPU} interactive double
# Extract data so that we don't have to download the whole stinking ODB file
# ${ABQ9} python ExtractODBdata.py -- ${JOBN}.odb

#append numbers to the filenames so that all our data is not lost when we run multiple experiments in one go
python addNumbers.py

#move folder to the current results folder so that we don't have to redo the folders manually on the cluster
cd
mkdir -p ${FINAL_DIR}
mv ${SCRATCH_DIR}/* ${FINAL_DIR}
rm -rf ${SCRATCH_DIR}
